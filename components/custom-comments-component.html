{% fetchxml global_setting_query %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="adx_setting">
        <attribute name="adx_settingid" />
        <attribute name="adx_name" />
        <attribute name="adx_value" />
        <attribute name="adx_description" />
        <attribute name="createdon" />
    </entity>
</fetch>
{% endfetchxml %}
{% assign global_settings = global_setting_query.results.entities %}

{% comment %} contains id for undocumented internal api. PackageImportComplete record is created(by system) during portal scaffolding {% endcomment %}
{% assign package_import_complete = global_settings | where: "adx_name", "PackageImportComplete" | select: "adx_value" %}


{% capture param_string %}{{ user_party_role_param }}{% endcapture %}
{% assign roles = param_string | split: ',' %}


{% fetchxml portal_comments_query %}
<fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="adx_portalcomment">
        <attribute name="activityid" />
        <attribute name="subject" />
        <attribute name="description" />
        <attribute name="av_party" />
        <attribute name="av_portaluser" />
        <attribute name="av_partyrole" />
        <attribute name="createdon" />
        <filter type="and">
            <filter type="or">
                <filter type="and">
                    <condition attribute="av_party" operator="eq" value="{{ user_party_type_param }}" />
                    <condition attribute="av_partyrole" operator="contain-values">
                        {% for role in roles %}<value>{{ role }}</value>{% endfor %}
                    </condition>
                </filter>
                <filter type="and">
                    <condition attribute="av_portaluser" operator="eq" value="{{ user.id }}" />
                </filter>
            </filter>
            {% comment %} helps with portal cache {% endcomment %}
            <condition attribute="createdon" operator="ne" value="{{ now }}" />
        </filter>
        <link-entity name="annotation" from="objectid" to="activityid" link-type="outer" alias="attachment">
            <attribute name="annotationid" />
            <attribute name="filename" />
            <attribute name="filesize" />
        </link-entity>
    </entity>
</fetch>
{% endfetchxml %}

{% assign portal_comments = portal_comments_query.results.entities %}

<div class="container">

    <!-- Button to open side panel -->
    <div class="comment-header">
        <button class="btn-add-comment" onclick="openCommentPanel()">
            Add Comment
        </button>
    </div>

    <!-- Side Panel -->
    <div class="comment-panel" id="commentPanel">
        <div class="comment-panel-overlay" onclick="closeCommentPanel()"></div>
        <div class="comment-panel-content">
            <div class="comment-panel-header">
                <h3>Add New Comment</h3>
                <button class="btn-close-panel" onclick="closeCommentPanel()">
                </button>
            </div>

            <div class="comment-panel-body">
                <form id="commentForm" onsubmit="return submitComment(event)">
                    <div class="form-group">
                        <label for="commentDescription">Comment</label>
                        <textarea id="commentDescription" class="form-textarea" rows="6"
                            placeholder="Enter your comment..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>Attachments <span style="color: #6c757d; font-weight: normal;">(Optional)</span></label>
                        <div class="file-upload-area" id="fileUploadArea"
                            onclick="document.getElementById('fileInput').click()">
                            <input type="file" id="fileInput" multiple style="display: none;">
                            <div class="file-upload-placeholder">
                                <svg width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                                    <path
                                        d="M0.5 9.9a0.5 0.5 0 0 1 0.5 0.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a0.5 0.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a0.5 0.5 0 0 1 0.5-0.5z" />
                                    <path
                                        d="M7.646 1.146a0.5 0.5 0 0 1 0.708 0l3 3a0.5 0.5 0 0 1-0.708 0.708L8.5 2.707V11.5a0.5 0.5 0 0 1-1 0V2.707L5.354 4.854a0.5 0.5 0 1 1-0.708-0.708l3-3z" />
                                </svg>
                                <p>Click to upload or drag and drop</p>
                                <span>PDF, DOC, DOCX, PNG, JPG (Max 10MB)</span>
                            </div>
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeCommentPanel()">Cancel</button>
                        <button type="submit" class="btn-primary" id="submitBtn">
                            <span class="btn-text">Submit Comment</span>
                            <span class="btn-spinner" style="display: none;">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                    <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="10 30" class="spinner-circle"/>
                                </svg>
                                Submitting...
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Comment Cards -->
    <div class="comment-cards-container">
        {% assign VISIBLE_COMMENTS = 3 %}
        {% for portal_comment in portal_comments %}
        <div class="comment-card{% if forloop.index > VISIBLE_COMMENTS %} comment-hidden{% endif %}">
            <div class="comment-card-body">
                <h5 class="comment-title">{{ portal_comment.subject }}</h5>
                <p class="comment-text">{{ portal_comment.description }}</p>
                <small class="comment-date">Created: {{ portal_comment.createdon | date: 'dd/MM/yyyy HH:mm' }}</small>

                <div class="comment-attachments">
                    {% if portal_comment['attachment.filename'] %}
                    <div class="attachment-item">
                        <div class="attachment-icon">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path
                                    d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z" />
                            </svg>
                        </div>
                        <div class="attachment-details">
                            <span class="attachment-name">{{ portal_comment['attachment.filename'] }}</span>
                            <span class="attachment-size">{{ portal_comment['attachment.filesize'] | divided_by: 1024 |round: 2 }} KB</span>
                        </div>
                        <a href="/_entity/annotation/{{ portal_comment['attachment.annotationid'] }}/{{ package_import_complete.adx_value }}"
                            class="btn-download-attachment" download
                            title="Download {{ portal_comment['attachment.filename'] }}">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path
                                    d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z" />
                                <path
                                    d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z" />
                            </svg>
                        </a>
                    </div>
                    {% else %}
                    <div class="attachment-item attachment-item-no-files">
                        <div class="attachment-details">
                            <span class="attachment-name">No files attached</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- See more button for comments -->
    {% if portal_comments.size > 3 %}
    <div class="comment-expand-container">
        <button type="button" class="comment-expand-btn" id="commentExpandBtn">
            <span class="comment-expand-text">See more</span>
            <svg class="comment-expand-icon" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M2.5 4.5L6 8L9.5 4.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
    </div>
    {% endif %}

</div>

<style>
    /* Container Spacing */
    .container {
        padding-top: 2rem;
    }

    /* Comment Header */
    .comment-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 1.5rem;
    }

    /* Comment Cards Container */
    .comment-cards-container {
        margin-top: 2rem;
    }

    /* Existing card styles */
    .comment-card {
        position: relative;
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        border-left: 4px solid #0d6efd;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    /* Hidden comments - See more functionality */
    .comment-card.comment-hidden {
        display: none;
    }

    .comment-card.comment-hidden.comment-visible {
        display: block;
    }

    .comment-expand-container {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        padding: 0;
        text-align: center;
    }

    .comment-expand-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: transparent;
        border: none;
        border-radius: 4px;
        color: #0f6cbd;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.1s ease;
    }

    .comment-expand-btn:hover {
        background: rgba(15, 108, 189, 0.08);
    }

    .comment-expand-btn:active {
        background: rgba(15, 108, 189, 0.12);
    }

    .comment-expand-btn.comment-expanded .comment-expand-icon {
        transform: rotate(180deg);
    }

    .comment-expand-icon {
        transition: transform 0.2s ease;
    }

    .comment-card:hover {
        box-shadow: 0 4px 16px rgba(13, 110, 253, 0.15);
    }

    .comment-card-body {
        padding: 1.5rem;
    }

    .comment-title {
        color: #212529;
        font-weight: 600;
        font-size: 1.125rem;
        margin: 0 0 0.75rem 0;
    }

    .comment-text {
        color: #495057;
        line-height: 1.6;
        margin: 0 0 0.5rem 0;
    }

    .comment-date {
        color: #6c757d;
        font-size: 0.875rem;
        display: block;
    }

    /* Comment Attachments */
    .comment-attachments {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.625rem;
        background: #f8f9fa;
        border-radius: 6px;
        transition: background 0.2s ease;
    }

    .attachment-item:hover {
        background: #e9ecef;
    }

    .attachment-item-no-files {
        background: transparent;
        padding: 0.375rem;
    }

    .attachment-item-no-files:hover {
        background: transparent;
    }

    .attachment-item-no-files .attachment-name {
        color: #6c757d;
        font-style: italic;
        font-weight: 400;
    }

    .attachment-icon {
        width: 32px;
        height: 32px;
        background: #0d6efd;
        color: #ffffff;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .attachment-details {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
    }

    .attachment-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #212529;
    }

    .attachment-size {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .btn-download-attachment {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: #0d6efd;
        color: #ffffff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        flex-shrink: 0;
    }

    .btn-download-attachment:hover {
        background: #0a58ca;
    }

    /* Add Comment Button */
    .btn-add-comment {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: #0d6efd;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
    }

    .btn-add-comment:hover {
        background: #0a58ca;
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
    }

    /* Side Panel */
    .comment-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .comment-panel.active {
        visibility: visible;
        opacity: 1;
    }

    .comment-panel-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    .comment-panel-content {
        position: absolute;
        top: 0;
        right: -500px;
        width: 100%;
        max-width: 500px;
        height: 100%;
        background: #ffffff;
        box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .comment-panel.active .comment-panel-content {
        right: 0;
    }

    .comment-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e0e0e0;
        background: #f8f9fa;
    }

    .comment-panel-header h3 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #212529;
    }

    .btn-close-panel {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: #6c757d;
        transition: color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-close-panel:hover {
        color: #212529;
    }

    .comment-panel-body {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
    }

    /* Form Styles */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #212529;
        font-size: 0.875rem;
    }

    .form-input,
    .form-textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        font-size: 0.9375rem;
        color: #495057;
        transition: all 0.2s ease;
        font-family: inherit;
    }

    .form-input:focus,
    .form-textarea:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }

    .form-textarea {
        resize: vertical;
        min-height: 120px;
    }

    .form-textarea:disabled {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    /* File Upload */
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .file-upload-area:hover {
        border-color: #0d6efd;
        background: #f8f9ff;
    }

    .file-upload-placeholder {
        padding: 2rem;
        text-align: center;
        cursor: pointer;
    }

    .file-upload-placeholder svg {
        color: #0d6efd;
        margin-bottom: 1rem;
    }

    .file-upload-placeholder p {
        margin: 0 0 0.5rem 0;
        font-weight: 500;
        color: #212529;
    }

    .file-upload-placeholder span {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .file-list {
        padding: 0 1rem 1rem 1rem;
    }

    .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 0.5rem;
    }

    .file-item-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .file-item-icon {
        width: 32px;
        height: 32px;
        background: #0d6efd;
        color: #ffffff;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .file-item-details {
        flex: 1;
    }

    .file-item-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #212529;
        margin: 0 0 0.25rem 0;
    }

    .file-item-size {
        font-size: 0.75rem;
        color: #6c757d;
        margin: 0;
    }

    .btn-remove-file {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
        padding: 0.25rem;
        display: flex;
        align-items: center;
        transition: opacity 0.2s ease;
    }

    .btn-remove-file:hover {
        opacity: 0.7;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e0e0e0;
    }

    .btn-primary,
    .btn-secondary {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 0.9375rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background: #0d6efd;
        color: #ffffff;
    }

    .btn-primary:hover {
        background: #0a58ca;
    }

    .btn-secondary {
        background: #6c757d;
        color: #ffffff;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    /* Button Spinner */
    .btn-spinner {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .spinner-circle {
        animation: spinner-rotate 1s linear infinite;
    }

    @keyframes spinner-rotate {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-secondary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>

<script>
    var selectedFiles = [];

    // Handle comment expand/collapse
    (function() {
        var expandBtn = document.getElementById("commentExpandBtn");
        if (expandBtn) {
            var isExpanded = false;
            expandBtn.addEventListener("click", function() {
                isExpanded = !isExpanded;
                var hiddenComments = document.querySelectorAll(".comment-hidden");
                var btnText = expandBtn.querySelector(".comment-expand-text");
                
                hiddenComments.forEach(function(comment) {
                    comment.classList.toggle("comment-visible", isExpanded);
                });
                
                expandBtn.classList.toggle("comment-expanded", isExpanded);
                btnText.textContent = isExpanded ? "See less" : "See more";
            });
        }
    })();

    function openCommentPanel() {
        document.getElementById('commentPanel').classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeCommentPanel() {
        document.getElementById('commentPanel').classList.remove('active');
        document.body.style.overflow = '';
        document.getElementById('commentForm').reset();
        document.getElementById('fileList').innerHTML = '';
        selectedFiles = [];
    }

    function submitComment(e) {
        e.preventDefault();

        var description = document.getElementById('commentDescription').value;

        console.log('Description:', description);
        console.log('Files:', selectedFiles);

        // Your AJAX submission code here

        closeCommentPanel();
        alert('Comment submitted successfully!');

        return false;
    }

    // File handling
    document.getElementById('fileInput').addEventListener('change', function (e) {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            if (file.size > 10 * 1024 * 1024) {
                alert(file.name + ' is too large. Max file size is 10MB.');
                continue;
            }
            selectedFiles.push(file);
            addFileToList(file);
        }
    }

    function addFileToList(file) {
        var fileList = document.getElementById('fileList');
        var fileItem = document.createElement('div');
        fileItem.className = 'file-item';

        var ext = file.name.split('.').pop().toUpperCase();
        var size = formatFileSize(file.size);

        fileItem.innerHTML = '<div class="file-item-info"><div class="file-item-icon">' + ext + '</div><div class="file-item-details"><p class="file-item-name">' + file.name + '</p><p class="file-item-size">' + size + '</p></div></div><button type="button" class="btn-remove-file" onclick="removeFile(\'' + file.name + '\', this)"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>';

        fileList.appendChild(fileItem);
    }

    function removeFile(filename, button) {
        selectedFiles = selectedFiles.filter(function (f) { return f.name !== filename; });
        button.closest('.file-item').remove();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        var k = 1024;
        var sizes = ['Bytes', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function getRequestVerificationToken() {
        var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
        return tokenInput ? tokenInput.value : '';
    }

    function submitComment(e) {
        e.preventDefault();

        var description = document.getElementById('commentDescription').value;

        console.log('Description:', description);
        console.log('Files:', selectedFiles);

        // Call the portal comment API
        addPortalComment(description, selectedFiles);

        return false;
    }

    function addPortalComment(description, files) {
        const submitBtn = document.getElementById('submitBtn');
        const btnText = submitBtn.querySelector('.btn-text');
        const btnSpinner = submitBtn.querySelector('.btn-spinner');
        const commentForm = document.getElementById('commentForm');
        const cancelBtn = document.querySelector('.btn-secondary');
        const textarea = document.getElementById('commentDescription');
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const removeFileBtns = document.querySelectorAll('.btn-remove-file');
        
        // Show spinner and disable everything
        btnText.style.display = 'none';
        btnSpinner.style.display = 'flex';
        submitBtn.disabled = true;
        cancelBtn.disabled = true;
        textarea.disabled = true;
        fileInput.disabled = true;
        fileUploadArea.style.pointerEvents = 'none';
        fileUploadArea.style.opacity = '0.6';
        removeFileBtns.forEach(function(btn) {
            btn.disabled = true;
            btn.style.pointerEvents = 'none';
        });

        const url = "/_portal/fcb2cba5-ed9c-49ee-9274-e8116e8bc3a5/EntityActivity/AddPortalComment";
        const bodyToken = getRequestVerificationToken();

        const formData = new FormData();

        const regardingEntityId = "{{ regarding_id_param }}";
        const regardingEntityLogicalName = "{{ regarding_entity_logical_name_param }}";

        formData.append("regardingEntityLogicalName", regardingEntityLogicalName);
        formData.append("regardingEntityId", regardingEntityId);
        formData.append("text", description || "");
        formData.append("isRequired", "");
        formData.append("isPrivate", "false");
        formData.append("__RequestVerificationToken", bodyToken || "");

        // Handle file uploads - append actual file objects
        if (files && files.length > 0) {
            files.forEach(function (file) {
                formData.append("file", file);  // Append the actual file object, not just the name
            });
        } else {
            formData.append("file", "");
        }

        fetch(url, {
            method: "POST",
            credentials: "same-origin",
            headers: {
                // Remove Content-Type header - browser will set it automatically with boundary for multipart/form-data
                "Accept": "*/*",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: formData  // Use FormData instead of URLSearchParams
        })
            .then(response => {
                console.log("AddPortalComment status:", response.status);
                if (response.ok) {
                    location.reload();
                } else {
                    // Re-enable everything on error
                    btnText.style.display = 'inline';
                    btnSpinner.style.display = 'none';
                    submitBtn.disabled = false;
                    cancelBtn.disabled = false;
                    textarea.disabled = false;
                    fileInput.disabled = false;
                    fileUploadArea.style.pointerEvents = 'auto';
                    fileUploadArea.style.opacity = '1';
                    removeFileBtns.forEach(function(btn) {
                        btn.disabled = false;
                        btn.style.pointerEvents = 'auto';
                    });
                    alert('Failed to submit comment. Status: ' + response.status);
                }
            })
            .catch(err => {
                // Re-enable everything on error
                btnText.style.display = 'inline';
                btnSpinner.style.display = 'none';
                submitBtn.disabled = false;
                cancelBtn.disabled = false;
                textarea.disabled = false;
                fileInput.disabled = false;
                fileUploadArea.style.pointerEvents = 'auto';
                fileUploadArea.style.opacity = '1';
                removeFileBtns.forEach(function(btn) {
                    btn.disabled = false;
                    btn.style.pointerEvents = 'auto';
                });
                console.error("Error calling AddPortalComment:", err);
                alert('Error submitting comment: ' + err.message);
            });
    }
</script>